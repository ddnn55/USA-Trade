<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>US Imports and Exports, 1985-2011</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      .overlay { /*background-color: white; opacity:0.8; filter:alpha(opacity=80);*/ }
      #timeline { height: 3em; width: 100%; z-index: 1000; position: fixed; top: 0px; left: 0px;}
      #slider { width: 20em; }
      #sidebar { width: 15em; z-index:1001; position:fixed; top:3em; bottom:0px; right:0px; }
      #map_canvas { height: * }
    </style> 
    <link type="text/css" href="css/start/jquery-ui-1.8.17.custom.css" rel="Stylesheet" />
    <link type="text/css" href="css/tooltip.css" rel="Stylesheet" />
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCkETvZyOg_-XCWnwlTRFKbnO-sMlGOqvk&sensor=false&libraries=geometry">
    </script>
    <script type="text/javascript" src="js/tooltip.js"></script>
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript">
      USA_SPACING = 7.0;
      THOUSAND_DOLLARS_PER_PIXEL_WIDTH = 100000.0;
      USA_COORDINATE = new google.maps.LatLng(39.095963,-97.207031); // USA

      var map;
      var trade_flows = {};
      var years;

      function createTradeFlows(country_name, country) {
        //var USA_COORDINATE = new google.maps.LatLng(39.095963,-97.207031); // USA
        var   toCoordinate = new google.maps.LatLng(country['latLng'][0], country['latLng'][1]);

        var heading        = google.maps.geometry.spherical.computeHeading(USA_COORDINATE, toCoordinate);
        var reverseHeading = google.maps.geometry.spherical.computeHeading(toCoordinate, USA_COORDINATE);
        heading        = heading * Math.PI / 180.0;
        reverseHeading = reverseHeading * Math.PI / 180.0;
        var usaRoomCoordinate = new google.maps.LatLng(USA_COORDINATE.lat() +     USA_SPACING * Math.cos(heading),
                                                       USA_COORDINATE.lng() + 2 * USA_SPACING * Math.sin(heading));
      

        var exportCoordinates = [ usaRoomCoordinate, toCoordinate, toCoordinate, usaRoomCoordinate ];
        var importCoordinates = [ toCoordinate, usaRoomCoordinate, usaRoomCoordinate, toCoordinate ];

        function createPath(type, country_name, coords, color, hover_color) {
           var flow = new google.maps.Polygon({
              path: coords,
              fillColor: color,
              fillOpacity: 0.8,
              strokeWeight: 0,
              geodesic: true
           });

           flow.setMap(map);

           google.maps.event.addListener(flow, 'mouseover', function(event) {
              flow.setOptions({ fillColor: hover_color});
              tooltip.show(country_name, 200);
           });
           //google.maps.event.addListener(flow, 'mousemove', function(event) {
           //});
           google.maps.event.addListener(flow, 'mouseout', function(event) {
              flow.setOptions({ fillColor: color});
              tooltip.hide();
           });
           trade_flows[country_name][type] = flow;
        }

        trade_flows[country_name] = {};
        createPath('export', country_name, exportCoordinates, '#333333', '#666666');
        createPath('import', country_name, importCoordinates, '#CC3333', '#FF6666');
      }

      function updateFlow(type, country, trade_volume) {
         //console.log(trade_flows[country][type]);
         var fromCoordinate = new google.maps.LatLng(
            trade_flows[country][type].getPath().getAt(0).lat(),
            trade_flows[country][type].getPath().getAt(0).lng()
         );
         var toCoordinate   = new google.maps.LatLng(
            trade_flows[country][type].getPath().getAt(1).lat(),
            trade_flows[country][type].getPath().getAt(1).lng()
         );
 
         var heading        = google.maps.geometry.spherical.computeHeading(fromCoordinate, toCoordinate);
         var reverseHeading = google.maps.geometry.spherical.computeHeading(toCoordinate, fromCoordinate);
         heading        = heading * Math.PI / 180.0;
         reverseHeading = reverseHeading * Math.PI / 180.0;


         var fromLeftHeading  = heading - Math.PI / 2.0;
         //var fromRightHeading = heading + Math.PI / 2.0;
         //var toLeftHeading    = reverseHeading - Math.PI / 2.0;
         var toRightHeading   = reverseHeading + Math.PI / 2.0;
    
         // TODO do nice freaky arrow heads
 
         var fromLeftCoord = new google.maps.LatLng(fromCoordinate.lat() + trade_volume * Math.cos(fromLeftHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH,
                                                    fromCoordinate.lng() + trade_volume * Math.sin(fromLeftHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH);
         var toRightCoord  = new google.maps.LatLng(toCoordinate.lat()   + trade_volume * Math.cos(toRightHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH,
                                                    toCoordinate.lng()   + trade_volume * Math.sin(toRightHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH);

         // update toRightCoord
         trade_flows[country][type].getPath().setAt(2, toRightCoord);

         // update fromLeftCoord
         trade_flows[country][type].getPath().setAt(3, fromLeftCoord);

      }

      function updateFlows(country, stats) {
         export_volume = parseFloat(stats['exports_year_total']);
         import_volume = parseFloat(stats['imports_year_total']);
         updateFlow('export', country, export_volume);
         updateFlow('import', country, import_volume);
      }

      function setYear(year) {
         $.each(years[year], function(country, stats) {
            if(country in trade_flows) {
               updateFlows(country, stats);
            }
         });
      }


      function initialize() {
         var myOptions = {
            center: new google.maps.LatLng(0, 150.644),
            disableDefaultUI: true,
            zoom: 2,
            mapTypeId: google.maps.MapTypeId.ROADMAP
         };
         map = new google.maps.Map(document.getElementById("map_canvas"),
            myOptions);

         $.getJSON('usa_trade_data.js', null, function(data) {
            console.log(data);
            low = -1;
            high = -1;
            $.each(data, function(key, value) {
               if(key == 'countries') {
                  geocodes = value;
                  // TODO order by length and draw longer lines first, so they don't cover up smaller lines
                  $.each(value, function(country_name, country) {
                     if( country_name != "North America" &&
                         country_name != "Europe" &&
                         country_name != "NICS" &&
                         country_name != "OPEC" &&
                         country_name != "Africa" ) {
                        //console.log(country_name);
                        createTradeFlows(country_name, country);
                     }
                  });
               }
               if(key == 'trade') {
                  years = value;
                  $.each(value, function(year, countries) {

                     year = parseInt(year);

                     if(high == -1) {
                        high = year;
                        low = year;
                     }
                     if(year > high)
                        high = year;
                     if(year < low)
                        low = year;
                  });

                  //console.log(low);
                  //console.log(high);

                  $( "#slider" ).slider({
                     value:low,
                     min: low,
                     max: high,
                     step: 1,
                     slide: function( event, ui ) {
                        setYear(ui.value);
                        $( "#year" ).val( "$" + ui.value );
                     }
                  });
                  $( "#year" ).val( "$" + $( "#slider" ).slider( "value" ) );

               }
            });

            //console.log(trade_paths);


            setYear(low);


         });


      }







    </script>

   <!-- Google Analytics -->
   <script type="text/javascript">
     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-12257817-1']);
     _gaq.push(['_trackPageview']);

     (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
   </script>

  </head>
  <body onload="initialize()">


<!-- stuff goes here -->





<div id="timeline" class="overlay">
   <input type="text" id="year" style="border:0; color:#f6931f; font-weight:bold;" />
   <div id="slider"></div>
</div>
<!--<div id="sidebar" class="overlay"></div>-->

<div id="map_canvas" style="width:100%; height:100%;"></div>


<script src="http://static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66493014); }catch(e){}</script>

  </body>
</html>

