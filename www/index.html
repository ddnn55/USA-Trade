<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>US Imports and Exports, 1985-2011</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0; overflow:hidden; }
      .overlay { background-color: #333; color: #eee; opacity:0.8; filter:alpha(opacity=80); }
      .import_dollars { color: #ff6666; }
      .export_dollars { color: #6f6; }
      #header { width: 100%; z-index: 1000; position: fixed; top: 0px; left: 0px; padding: 0.5em; text-align: center;}
      #header div { display:inline; }
      #title { font-size: 2em;}
      #timeline_container { text-align:center; position: fixed; bottom: 3em; width:100%; height:5em; z-index: 1000; }
      #timeline { /*text-align: center; display:inline; /*width: 84em;*/ z-index: 1000; /*position: fixed;*/ /*bottom: 3em;*/ margin: 0px auto; padding: 0.5em 1.5em;}
      #slider { width: 74em; margin: 0.5em;}
      #slider_ticks { display: block; }
      #slider_ticks div { display: inline; position:absolute; }
      .not_current_tick { z-index: 1002; }
      .current_tick { font-size: 300%; position:absolute; top: -1.25em; margin-left: -1.1em; background-color: #333; padding:0 0.25em; z-index: 1001; }
      /*#sidebar { width: 15em; z-index:1001; position:fixed; top:3em; bottom:0px; right:0px; }*/
      #map_canvas { height: * }
    </style> 
    <link type="text/css" href="css/start/jquery-ui-1.8.17.custom.css" rel="Stylesheet" />
    <link type="text/css" href="css/tooltip.css" rel="Stylesheet" />
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCkETvZyOg_-XCWnwlTRFKbnO-sMlGOqvk&sensor=false&libraries=geometry">
    </script>
    <script type="text/javascript" src="js/tooltip.js"></script>
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript">
      USA_SPACING_X = 24.0;
      USA_SPACING_Y = 7.0;
      THOUSAND_DOLLARS_PER_PIXEL_WIDTH = 100000.0;
      USA_COORDINATE = new google.maps.LatLng(39.095963,-102.207031); // USA

      var map;
      var trade_flows = {};
      var years;
      var countries = {};
      var tips = {};

      var current_year;
      var last_hash = null;


      initial_year = null;
      initial_latlng = null;
      initial_zoom = null;
      initial_parts = window.location.hash.split('/');
      if(initial_parts.length == 4)
      {
         initial_year = initial_parts[1];
         initial_latlng = new google.maps.LatLng(initial_parts[2].split(',')[0], initial_parts[2].split(',')[1]);
         initial_zoom = parseInt(initial_parts[3]);
      }


      function setState(hash) {
         parts = hash.split('/');
         if(parts.length == 4)
         {
            console.log('doin stuff');
            console.log(parts);
            year = parts[1];
            latlng = new google.maps.LatLng(parts[2].split(',')[0], parts[2].split(',')[1]);
            zoom = parseInt(parts[3]);

            map.setZoom(zoom);
            map.setCenter(latlng);
            setYear(year);
            $('#slider').slider('value', year);
            console.log('did stuff');
         }
      }

      function createTradeFlows(country_name, country) {
        //var USA_COORDINATE = new google.maps.LatLng(39.095963,-97.207031); // USA
        var   toCoordinate = new google.maps.LatLng(country['latLng'][0], country['latLng'][1]);

        var heading        = google.maps.geometry.spherical.computeHeading(USA_COORDINATE, toCoordinate);
        var reverseHeading = google.maps.geometry.spherical.computeHeading(toCoordinate, USA_COORDINATE);
        heading        = heading * Math.PI / 180.0;
        reverseHeading = reverseHeading * Math.PI / 180.0;
        var usaRoomCoordinate = new google.maps.LatLng(USA_COORDINATE.lat() + USA_SPACING_Y * Math.cos(heading),
                                                       USA_COORDINATE.lng() + USA_SPACING_X * Math.sin(heading));
      
        var fromLeftHeading  = heading + Math.PI / 2.0;
        var fromRightHeading  = heading - Math.PI / 2.0;
        var toLeftHeading   = reverseHeading + Math.PI / 2.0;
        var toRightHeading   = reverseHeading - Math.PI / 2.0;

        countries[country_name] = {
           'export': {
              'fromLeftHeading': fromLeftHeading,
              'toRightHeading':  toRightHeading 
           },
           'import': {
              'fromLeftHeading': toLeftHeading,
              'toRightHeading':  fromRightHeading 
           }
        };

        var exportCoordinates = [ usaRoomCoordinate, toCoordinate, toCoordinate, usaRoomCoordinate ];
        var importCoordinates = [ toCoordinate, usaRoomCoordinate, usaRoomCoordinate, toCoordinate ];

        function createPath(type, country_name, coords, color, hover_color) {
           var flow = new google.maps.Polygon({
              path: coords,
              fillColor: color,
              fillOpacity: 0.8,
              strokeWeight: 0,
              geodesic: true
           });

           flow.setMap(map);

           google.maps.event.addListener(flow, 'mouseover', function(event) {
              flow.setOptions({ fillColor: hover_color});
              tooltip.show(tips[current_year][country_name][type], 200);
           });
           //google.maps.event.addListener(flow, 'mousemove', function(event) {
           //});
           google.maps.event.addListener(flow, 'mouseout', function(event) {
              flow.setOptions({ fillColor: color});
              tooltip.hide();
           });
           trade_flows[country_name][type] = flow;
        }

        trade_flows[country_name] = {};
        createPath('export', country_name, exportCoordinates, '#555', '#333');
        createPath('import', country_name, importCoordinates, '#C55', '#C33');
      }

      function updateFlow(type, country, trade_volume) {
         fromCoordinate = trade_flows[country][type].getPath().getAt(0);
         toCoordinate   = trade_flows[country][type].getPath().getAt(1);

         fromLeftHeading = countries[country][type]['fromLeftHeading'];
         toRightHeading  = countries[country][type]['toRightHeading'];

         // TODO do nice freaky arrow heads
 
         fromLeftCoord = new google.maps.LatLng(fromCoordinate.lat() + trade_volume * Math.cos(fromLeftHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH,
                                                fromCoordinate.lng() + trade_volume * Math.sin(fromLeftHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH);
         toRightCoord  = new google.maps.LatLng(toCoordinate.lat()   + trade_volume * Math.cos(toRightHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH,
                                                toCoordinate.lng()   + trade_volume * Math.sin(toRightHeading) / THOUSAND_DOLLARS_PER_PIXEL_WIDTH);

         // update toRightCoord
         trade_flows[country][type].getPath().setAt(2, toRightCoord);

         // update fromLeftCoord
         trade_flows[country][type].getPath().setAt(3, fromLeftCoord);

      }

      function updateFlows(country, stats) {
         export_volume = parseFloat(stats['exports_year_total']);
         import_volume = parseFloat(stats['imports_year_total']);
         updateFlow('export', country, export_volume);
         updateFlow('import', country, import_volume);
      }

      function setYear(year) {
         current_year = year;
         $.each(years[year], function(country, stats) {
            if(country in trade_flows) {
               updateFlows(country, stats);
            }
         });
         $('#slider_ticks div').removeClass('current_tick');
         $('#slider_ticks div').addClass('not_current_tick');
         $('#tick'+year).addClass('current_tick');
      }


      function formatMillionsOfDollars(millions, css_class) {
         dollars = Math.floor(millions) * 1000000;
         dollars = dollars.toString();
         dollars_with_commas = "";
         for(c = dollars.length-1; c >= 0; c--) {
            dollars_with_commas = dollars[c] + dollars_with_commas;
            if((dollars.length - c) % 3 == 0 && c != 0)
               dollars_with_commas = ',' + dollars_with_commas;
         }
         return '<span class="'+css_class+'">$'+dollars_with_commas+'</span>';
      }

      function updateHash() {
         if(last_hash != window.location.hash) {
            console.log("not last hash");
            last_hash = window.location.hash;
            setState(window.location.hash);
         }
         else {
            window.location.hash = "/" + current_year + "/" + map.getCenter().toUrlValue() + "/" + map.getZoom();
            last_hash = window.location.hash;
         }
      }

      function initialize() {
         var myOptions = {
            //center: USA_COORDINATE,
            center: initial_latlng ? initial_latlng : USA_COORDINATE,
            disableDefaultUI: true,
            zoom: initial_zoom ? initial_zoom : 3,
            mapTypeId: google.maps.MapTypeId.ROADMAP
         };
         map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
         //google.maps.event.addListener(map, 'bounds_changed', function() {
         //   window.location.hash = "/" + map.getCenter().toUrlValue();
         //});

         var int=self.setInterval("updateHash()", 1000);

         $.getJSON('usa_trade_data.js', null, function(data) {
            console.log(data);
            low = -1;
            high = -1;
            $.each(data, function(key, value) {
               if(key == 'countries') {
                  geocodes = value;
                  // TODO order by length and draw longer lines first, so they don't cover up smaller lines
                  $.each(value, function(country_name, country) {
                     if( country_name != "North America" &&
                         country_name != "Europe" &&
                         country_name != "NICS" &&
                         country_name != "OPEC" &&
                         country_name != "Africa" ) {
                        //console.log(country_name);
                        createTradeFlows(country_name, country);
                     }
                  });
               }
               if(key == 'trade') {
                  years = value;
                  $.each(value, function(year, countries) {

                     year = parseInt(year);

                     if(high == -1) {
                        high = year;
                        low = year;
                     }
                     if(year > high)
                        high = year;
                     if(year < low)
                        low = year;

                     tips[year] = {};
                     $.each(countries, function(country_name, stats) {
                        tips[year][country_name] = {};
                        import_volume = formatMillionsOfDollars(stats['imports_year_total'], 'import_dollars');
                        export_volume = formatMillionsOfDollars(stats['exports_year_total'], 'export_dollars');
                        tips[year][country_name]['import'] = ''+import_volume+" imported from "+country_name+" in "+year;
                        tips[year][country_name]['export'] = '' + export_volume+" exported to "+country_name+" in "+year;
                     });

                  });

                  //console.log(low);
                  //console.log(high);

                  $( "#slider" ).slider({
                     value:high,
                     min: low,
                     max: high,
                     step: 1,
                     slide: function( event, ui ) {
                        $('#tick'+current_year).removeClass('current_tick');
                        $('#tick'+current_year).addClass('not_current_tick');
                        setYear(ui.value);
                        $( "#year" ).val( "$" + ui.value );
                     }
                  });
                  $( "#year" ).val( "$" + $( "#slider" ).slider( "value" ) );


                  $('#low').html(low);
                  $('#high').html(high);
            
                  slider_width = $('#slider').width();
                  console.log(slider_width);
                  for(y = low; y <= high; y += 1) {
                     fraction = (y - low) / (high - low);
                     $('#slider_ticks').append('<div class="not_current_tick" id="tick'+y+'">'+y+'</div>');
                     $('#tick'+y).css({
                        left: (slider_width * (fraction))+10 + "px"
                     });
                  }



               }
            });

            //console.log(trade_paths);




            setYear(initial_year ? initial_year : high);
            //setState(window.location.hash);

            console.log('tips:');
            console.log(tips);


         });


      }







    </script>

   <!-- Google Analytics -->
   <script type="text/javascript">
     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-12257817-1']);
     _gaq.push(['_trackPageview']);

     (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
   </script>

  </head>
  <body onload="initialize()">


<!-- stuff goes here -->





<div id="header" class="overlay">
   <input type="text" id="year" style="border:0; color:#f6931f; font-weight:bold;display:none;" />
   <div id="title">U.S. Imports and Exports in Nominal Dollars, <span id="low">&nbsp;</span>-<span id="high">&nbsp;</span></div>
</div>
<!--<div id="sidebar" class="overlay"></div>-->


<div id="timeline_container">
   <div id="timeline" class="overlay">
      <div id="slider_ticks">&nbsp;</div>
      <div id="slider"></div>
   </div>
</div>

<div id="map_canvas" style="width:100%; height:100%;"></div>


<script src="http://static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66493014); }catch(e){}</script>

  </body>
</html>

